services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - DOTENV_PRIVATE_KEY_PRODUCTION=${DOTENV_PRIVATE_KEY_PRODUCTION}
    user: node
    tmpfs:
      - /app/user_profile:mode=770,uid=1000,gid=1000
    networks:
      - sowonny-network
  
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    networks:
      - sowonny-network
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - api
‡∏∑
networks:
  sowonny-network:
    driver: bridge


# ===============================
# üß† Volume vs tmpfs (‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏´‡πâ‡∏à‡∏≥‡∏á‡πà‡∏≤‡∏¢)
# ===============================

# üîπ volume (named volume / bind mount)
# - ‡πÄ‡∏õ‡πá‡∏ô storage ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£ (persistent)
# - container restart / recreate ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà"
# - ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö:
#     ‚Ä¢ database
#     ‚Ä¢ user upload ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á
#     ‚Ä¢ cache ‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß
# - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:
#     ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (multer temp)
#       ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏∑‡∏°‡∏•‡∏ö ‚Üí ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£
#     ‚Ä¢ scale ‡∏´‡∏•‡∏≤‡∏¢ container ‡∏≠‡∏≤‡∏à‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏Å
#
# ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
# volumes:
#   - user_profile:/app/user_profile


# üîπ tmpfs
# - ‡πÄ‡∏õ‡πá‡∏ô storage ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô memory (RAM)
# - ‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å
# - container restart = ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
# - ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö:
#     ‚Ä¢ temp upload (multer)
#     ‚Ä¢ file ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏õ‡πä‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
#     ‚Ä¢ token / cache ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
# - ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ:
#     ‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡πâ‡∏≤‡∏á
#     ‚Ä¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á cleanup volume
#     ‚Ä¢ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤ temp file ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£
#
# ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
# tmpfs:
#   - /app/user_profile


# üîπ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ?
# - ‡∏ñ‡πâ‡∏≤ "‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö" ‚Üí volume
# - ‡∏ñ‡πâ‡∏≤ "‡πÉ‡∏ä‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏¥‡πâ‡∏á" ‚Üí tmpfs
# - multer upload ‚Üí ‡∏™‡πà‡∏á Cloudinary ‚Üí ‡∏•‡∏ö
#   = tmpfs ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

# ==============================================================================
# ‚ö†Ô∏è SECURITY & PERMISSION MEMO (‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ!)
# ==============================================================================
#
# 1. üõë USER ISOLATION (‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á user: node?)
#    - ‡πÇ‡∏î‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥ Docker ‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'root' ‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡πâ‡∏≤ Hacker ‡πÄ‡∏à‡∏≤‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ ‡πÄ‡∏Ç‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå root 
#      ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Host ‡πÑ‡∏î‡πâ (Container Escape)
#    - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ 'user: node' (UID 1000) ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ Hacker ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà "‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô" 
#      ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏±‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ
#
# 2. üõ°Ô∏è THE TMPFS TRAP (‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ï‡∏≠‡∏ô‡πÉ‡∏ä‡πâ tmpfs ‡∏ó‡∏±‡∏ö!)
#    - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ tmpfs, Docker ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Mount Point ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å RAM ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ó‡∏±‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°
#    - **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á:** Mount Point ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á 'root' ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 
#      ‡∏ó‡∏≥‡πÉ‡∏´‡πâ user 'node' ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡πÑ‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Permission Denied) ‡πÅ‡∏°‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á chown 
#      ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Dockerfile ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏ï‡∏≤‡∏° ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ tmpfs ‡∏°‡∏±‡∏ô‡∏°‡∏≤ "‡∏ó‡∏±‡∏ö" ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
#
# 3. üõ†Ô∏è SOLUTION: :mode=770,uid=1000,gid=1000
#    - 'uid=1000, gid=1000': ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ RAM ‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡∏ó‡∏±‡∏ö ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á user 'node' ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏¥‡∏î
#    - 'mode=770': ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (node) ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏° (group) ‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡∏£‡∏±‡∏ô ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà 
#      ‡πÅ‡∏ï‡πà "‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å" (Others) ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏∏‡πà‡∏á‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î!
#
# ==============================================================================