server {
    # ให้ nginx ฟัง request ที่พอร์ต 80 (HTTP ปกติ)
    # ใครเข้าเว็บผ่าน http://... จะวิ่งเข้ามาที่ server block นี้
    listen 80;

    # ระบุชื่อโดเมนที่ใช้กับ server block นี้
    # ตอนนี้ใช้ localhost สำหรับ local/dev
    # production มักจะเป็น api.xxx.com หรือ domain จริง
    server_name _; # รับทุก Request ที่วิ่งมาหาเครื่อง GCP นี้

    location / {
        # proxy_pass = ส่ง request ต่อไปยัง backend
        # api คือชื่อ service ใน docker-compose
        # 3000 คือ port ที่ backend (Elysia / Express / Bun) เปิดไว้
        # nginx ทำหน้าที่เป็น reverse proxy
        proxy_pass http://api:3000;

        # กำหนดให้ใช้ HTTP/1.1 ตอนคุยกับ backend
        # จำเป็นสำหรับ websocket, keep-alive และ feature บางอย่าง
        proxy_http_version 1.1;

        # รองรับ WebSocket:
        # ถ้า client ขอ upgrade connection (เช่น websocket)
        # nginx จะส่ง header นี้ต่อไปให้ backend
        proxy_set_header Upgrade $http_upgrade;

        # ใช้คู่กับ Upgrade
        # บอก backend ว่า connection นี้จะถูก upgrade
        proxy_set_header Connection 'upgrade';

        # ส่งค่า Host เดิมของ client ไปให้ backend
        # เช่น client เข้า api.sowon.dev
        # backend จะเห็น Host เป็น api.sowon.dev ไม่ใช่ api:3000
        proxy_set_header Host $host;

        # ถ้า request เป็นแบบ upgrade (เช่น websocket)
        # ให้ bypass cache ไม่ให้ nginx cache request นี้
        proxy_cache_bypass $http_upgrade;

        # ส่ง IP จริงของ client (โซวอน) ไปให้ backend
        # backend จะไม่เห็นแค่ IP ของ nginx
        proxy_set_header X-Real-IP $remote_addr;

        # เก็บ chain ของ IP ที่ request วิ่งผ่านทั้งหมด
        # ใช้สำหรับ logging, security, rate-limit
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
